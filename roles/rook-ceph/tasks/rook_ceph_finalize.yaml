---
- name: Read rook-ceph values from target node
  ansible.builtin.slurp:
    src: /root/rook-ceph/rook-ceph-cluster.values.yml
  register: rook_ceph_values_file

- name: Load rook-ceph values from file
  ansible.builtin.set_fact:
    rook_ceph_values: "{{ rook_ceph_values_file.content | b64decode | from_yaml }}"

- name: Set storage class name from rook-ceph values
  ansible.builtin.set_fact:
    rook_ceph_storage_class: "{{ rook_ceph_values.cephBlockPools[0].storageClass.name }}"

- name: Label the storage class with akash.network=true
  kubernetes.core.k8s:
    kind: StorageClass
    name: "{{ rook_ceph_storage_class }}"
    state: present
    definition:
      metadata:
        labels:
          akash.network: "true"

- name: Ensure 'rbd' module is listed in /etc/modules
  ansible.builtin.lineinfile:
    path: /etc/modules
    line: rbd
    state: present

- name: Load the 'rbd' kernel module
  community.general.modprobe:
    name: rbd
    state: present

- name: Create /root/provider directory for provider configuration
  ansible.builtin.file:
    path: /root/provider
    state: directory
    mode: '0755'

- name: Extract storage class name from rook-ceph-cluster.values.yml
  ansible.builtin.set_fact:
    storage_class_name: >-
      {{ rook_ceph_values.cephBlockPools
        | selectattr('storageClass.enabled', 'defined')
        | selectattr('storageClass.enabled')
        | map(attribute='storageClass.name')
        | list | first }}

- name: Display storage class configuration
  ansible.builtin.debug:
    msg: "Rook-Ceph storage class '{{ storage_class_name }}' is configured and will be detected by provider role"
