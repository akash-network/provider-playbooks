---
# STEP 3 - Configure NVIDIA CDI (Container Device Interface)
- name: Create CDI directory
  ansible.builtin.file:
    path: /etc/cdi
    state: directory
    mode: '0755'

- name: Generate NVIDIA CDI specification
  ansible.builtin.command: nvidia-ctk cdi generate --output=/etc/cdi/nvidia.yaml
  args:
    creates: /etc/cdi/nvidia.yaml
  register: cdi_generate

- name: Check if NVIDIA runtime configuration file exists
  ansible.builtin.stat:
    path: "{{ cruntime_toml_path }}"
  register: nvidia_config_file

- name: Check if backup file already exists
  ansible.builtin.stat:
    path: "{{ cruntime_toml_path }}_bk"
  register: backup_stat

- name: Take the backup of the existing file
  ansible.builtin.copy:
    src: "{{ cruntime_toml_path }}"
    dest: "{{ cruntime_toml_path }}_bk"
    remote_src: yes
  when: nvidia_config_file.stat.exists and not backup_stat.stat.exists

- name: Ensure NVIDIA Container Runtime config directory exists
  ansible.builtin.file:
    path: /etc/nvidia-container-runtime
    state: directory
    mode: '0755'

- name: Configure NVIDIA Container Runtime for CDI
  ansible.builtin.lineinfile:
    path: "{{ cruntime_toml_path }}"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    create: yes
    mode: '0644'
  loop:
    - regexp: '^#?\s*accept-nvidia-visible-devices-as-volume-mounts\s*='
      line: 'accept-nvidia-visible-devices-as-volume-mounts = false'
    - regexp: '^#?\s*accept-nvidia-visible-devices-envvar-when-unprivileged\s*='
      line: 'accept-nvidia-visible-devices-envvar-when-unprivileged = true'

- name: Verify CDI configuration
  ansible.builtin.command: grep -E "accept-nvidia-visible-devices" {{ cruntime_toml_path }}
  register: cdi_config_check
  changed_when: false
  failed_when: false

- name: Display CDI configuration
  ansible.builtin.debug:
    msg: "{{ cdi_config_check.stdout_lines }}"
